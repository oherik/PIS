QA12 - MC68HC12 Absolute crossassembler, Version 1.6.3
(c) GMV 1989-2013


File: Main.lst
                            1. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                            2. ;Adresser
       0000 0600            3. DipSwitch	equ	$600
       0000 0700            4. HexDisplay	equ	$700
       0000 0400            5. DrillControl	equ	$400
       0000 0401            6. DrillStatus	equ	$401
                            7. 
000000                      8. #ifdef	SIMULATOR
                           14. #else
       0000 0004           15. DelayConst	EQU	4
                           16. #endif000000                     17. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
001000                     18. 	org	$1000
001000                     19. 	
                           20. ;----------------------------------
                           21. ;	MAIN
                           22. ;----------------------------------	
001000                     23. 	
001000                     24. main_loop:
001000 16 10 3B            25. 	jsr	GetKbdML15	; Tangent till register B
001003 16 10 08            26. 	jsr	Command
001006 20 F8               27. 	bra	main_loop
001008                     28. 	
                           29. ;----------------------------------
                           30. ;	COMMAND
                           31. ;----------------------------------	
                           32. 
001008                     33. Command:
001008 C1 07               34. 	cmpb	#7
00100A 22 08               35. 	bhi	CommandExit
00100C CE 10 15            36. 	ldx	#JUMPTAB
00100F 58                  37. 	aslb		; 2 bytes per adress
001010                     38. 	ldx	b,x	; ladda rutinen
001012 15 00               39. 	jsr	,x
001014                     40. CommandExit:
001014 3D                  41. 	rts
                           42. 
                           43. ;---------------------------------
                           44. ;	Tabell med kommandon
                           45. 
001015 20 58 20 6E 20 78   46. JUMPTAB	fdb	MotorStart,MotorStop,DrillDown,DrillUp
       20 82            
00101D 20 AD 20 FA 21 04   47. 	fdb	Step,DrillHole,RefPos,SUB7
       10 25            
001025                     48. 	
                           49. ;---------------------------------
                           50. ;	Subrutiner fˆr test
                           51. 
       0000 0400           52. OutPortM	equ	$400
                           53. 
001025 18 0B 00 04 00      54. SUB7	movb	#0,OutPortM
00102A 3D                  55. 	rts
00102B                     56. 		
                           57. ;-------------------------------
                           58. ;	File uses
                           59. ;-------------------------------	
00102B                     60. 	
00102B                     61. 	;use	ML15drvr.s12
                           62. 	use	KeyboardML15.s12
---- File: "KeyboardML15.s12"
                           63. ;Testprogram
                           64. ;	org	$1000
                           65. ;start:	jsr	GetKbdML15
                           66. ;	cmpb	#$FF
                           67. ;	beq	start
                           68. ;	nop
                           69. ;	bra	start
                           70. ;	ldx	#tabell
                           71. ;start:	jsr	DisplayML15
                           72. ;	bra	start
                           73. ;
                           74. ;tabell:	fcb	1,2,3,4,5,6
                           75. 
00102B                     76. 	
00102B                     77. CheckKbdML15:
00102B F6 09 C0            78. 	ldab	$9c0
00102E 2A 03               79. 	bpl	CheckKbd_VA
001030 C6 FF               80. 	ldab	#$FF	
001032 3D                  81. 	rts
001033                     82. CheckKbd_VA:
001033 37                  83. 	pshb
001034                     84. CheckKbd_VA_active:
001034 F6 09 C0            85. 	ldab	$9c0
001037 2A FB               86. 	bpl	CheckKbd_VA_active
001039 33                  87. 	pulb
00103A 3D                  88. 	rts
00103B                     89. 	
00103B                     90. GetKbdML15:
00103B 16 10 2B            91. 	jsr	CheckKbdML15
00103E C1 FF               92. 	cmpb	#$FF
001040 27 F9               93. 	beq	GetKbdML15
001042 3D                  94. 	rts
001043                     95. 	
001043                     96. DisplayML15:
001043 86 01               97. 	ldaa	#1
001045 7A 09 C2            98. 	staa	$9c2
001048 86 D0               99. 	ldaa	#$d0
00104A 7A 09 C3           100. 	staa	$9c3
00104D 86 00              101. 	ldaa	#0
00104F 7A 09 C2           102. 	staa	$9c2
001052                    103. DisplayML15_compare_loop:
001052 81 06              104. 	cmpa	#6
001054 26 09              105. 	bne	DisplayML15_not_6
001056 86 00              106. 	ldaa	#0
001058 7A 09 C3           107. 	staa	$9c3
00105B 7A 09 C3           108. 	staa	$9c3
00105E 3D                 109. 	rts
00105F                    110. DisplayML15_not_6
00105F                    111. 	ldab	a,x
001061 7B 09 C3           112. 	stab	$9c3
001064 42                 113. 	inca
001065 20 EB              114. 	bra	DisplayML15_compare_loop
                          115. 
001067                    116. 	
001067                    117. 	001067                    118. 	;use	Delay.s12
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          119. 	use	Subroutines.s12
---- File: "Subroutines.s12"
                          120. #define	SIMUATOR
                          121. #define	RUNFAST
                          122. 		use	Labdefs.s12
---- File: "Labdefs.s12"
                          123. ;Adresser
       0000 0600          124. DipSwitch	equ	$600
       0000 0700          125. HexDisplay	equ	$700
       0000 0400          126. DrillControl	equ	$400
       0000 0401          127. DrillStatus	equ	$401
                          128. 
001067                    129. #ifdef	SIMULATOR
                          135. #else
       0000 0004          136. DelayConst	EQU	4
                          137. #endif                          138. 		use	Delay.s12
---- File: "Delay.s12"
                          139. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                          140. ;Adresser
       0000 0600          141. DipSwitch	equ	$600
       0000 0700          142. HexDisplay	equ	$700
       0000 0400          143. DrillControl	equ	$400
       0000 0401          144. DrillStatus	equ	$401
                          145. 
001067                    146. #ifdef	SIMULATOR
                          152. #else
       0000 0004          153. DelayConst	EQU	4
                          154. #endif002000                    155. 	org	$2000
---- File: "Delay.s12"
002000 34                 156. DELAY:	pshx		; 250 ms delay
002001 35                 157. 	pshy
002002 CE 00 04           158. 	ldx	#DelayConst
002005 1A 1F              159. NEXT:	leax	-1,x
002007 CD 00 64           160. 	ldy	#100
00200A 19 5F              161. NEXT2:	leay	-1,y
00200C 8D 00 00           162. 	cpy	#0
00200F 26 F9              163. 	bne	NEXT2
002011 8E 00 00           164. 	cpx	#0
002014 26 EF              165. 	bne	NEXT
002016 31                 166. 	puly
002017 30                 167. 	pulx
002018 3D                 168. 	rts	
002019                    169. 	
002019                    170. DELAY_B:		; Calls DELAY the number of times specified in B
002019 37                 171. 	pshb
00201A D7                 172. 	tstb
00201B                    173. DELAY_B_LOOP:
00201B 27 06              174. 	beq	DELAY_B_RETURN
00201D 16 20 00           175. 	jsr	DELAY
002020 53                 176. 	decb
002021 20 F8              177. 	bra	DELAY_B_LOOP
002023                    178. DELAY_B_RETURN:
002023 33                 179. 	pulb
002024 3D                 180. 	rts 002025                    181. 		
---- File: "Subroutines.s12"
                          182. ;---------------------------------
                          183. ;	OUTZERO
                          184. ;---------------------------------
                          185. 
                          186. ; Nollst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          187. 
002025                    188. Outzero:			
002025 39                 189. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002026 37                 190. 		pshb
002027 34                 191. 		pshx
002028 C1 07              192. 		cmpb	#7		
00202A 22 0F              193. 		bhi	Outzero_return	; Kolla om talet √§r >7
00202C CE 21 39           194. 		ldx	#Bitmask
00202F                    195. 		ldab	b,x				; Uppdatera b till bitmasken f√∂r b
002031 51                 196. 		comb	
002032 F4 21 41           197. 		andb	DCShadow		; Ta DCShadow && komplementet av bitmasken
002035 7B 04 00           198. 		stab	DrillControl	; Spara till borren
002038 7B 21 41           199. 		stab	DCShadow	; Spara till skuggningen
00203B                    200. Outzero_return:	
00203B 30                 201. 		pulx
00203C 33                 202. 		pulb			; √Öterst√§ll originalv√§rden
00203D 38                 203. 		pulc
00203E 3D                 204. 		rts
00203F                    205. 	
                          206. ;---------------------------------
                          207. ;	OUTONE
                          208. ;---------------------------------
                          209. 
                          210. ; Ettst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          211. 
00203F                    212. Outone:			
00203F 39                 213. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002040 37                 214. 		pshb
002041 34                 215. 		pshx
002042 C1 07              216. 		cmpb	#7		
002044 22 0E              217. 		bhi	Outone_return	; Kolla om talet √§r >7
002046 CE 21 39           218. 		ldx	#Bitmask
002049                    219. 		ldab	b,x	
00204B FA 21 41           220. 		orab	DCShadow	; Ta DCShadow || Bitmasken
00204E 7B 04 00           221. 		stab	DrillControl	; Spara till borren
002051 7B 21 41           222. 		stab	DCShadow	; Spara till skuggningen
002054                    223. Outone_return:	
002054 30                 224. 		pulx
002055 33                 225. 		pulb			; √Öterst√§ll originalv√§rden
002056 38                 226. 		pulc
002057 3D                 227. 		rts
002058                    228. 		
                          229. ;-------------------------------
                          230. ;	MOTORSTART
                          231. ;-------------------------------
                          232. 
002058                    233. MotorStart:
002058 37                 234. 	pshb
002059 39                 235. 	pshc
00205A F6 21 41           236. 	ldab	DCShadow
00205D C4 04              237. 	andb	#4
00205F 26 0A              238. 	bne	MotorStartExit	; Motorn redan startad
002061 C6 02              239. 	ldab	#2
002063 16 20 3F           240. 	jsr	Outone		; Ettst√§ll bit 2
002066                    241. 	
002066 C6 02              242. 	ldab	#2
002068 16 20 19           243. 	jsr	DELAY_B	; 4*250 ms delay
                          244. 
00206B                    245. MotorStartExit:
00206B 38                 246. 	pulc
00206C 33                 247. 	pulb
00206D 3D                 248. 	rts
00206E                    249. 	
                          250. ;-------------------------------
                          251. ;	MOTORSTOP
                          252. ;-------------------------------
                          253. 
00206E                    254. MotorStop:
00206E 37                 255. 	pshb
00206F 39                 256. 	pshc
002070 C6 02              257. 	ldab	#2
002072 16 20 25           258. 	jsr	Outzero		; Nollst√§ll bit 2
002075 38                 259. 	pulc
002076 33                 260. 	pulb
002077 3D                 261. 	rts
002078                    262. 	
                          263. ;-------------------------------
                          264. ;	DRILLDOWN
                          265. ;-------------------------------
                          266. 
002078                    267. DrillDown:
002078 37                 268. 	pshb
002079 39                 269. 	pshc
00207A C6 03              270. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
00207C 16 20 3F           271. 	jsr	Outone		; Ettst‰ll denna
00207F 38                 272. 	pulc
002080 33                 273. 	pulb
002081 3D                 274. 	rts
002082                    275. 	
                          276. ;-------------------------------
                          277. ;	DRILLUP
                          278. ;-------------------------------
                          279. 
002082                    280. DrillUp:
002082 37                 281. 	pshb
002083 39                 282. 	pshc
002084 C6 03              283. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
002086 16 20 25           284. 	jsr	Outzero		; Nollst‰ll denna
002089 38                 285. 	pulc
00208A 33                 286. 	pulb
00208B 3D                 287. 	rts
00208C                    288. 	
                          289. ;-------------------------------
                          290. ;	ALARM
                          291. ;-------------------------------
                          292. 
                          293. ; Antalet alarm ska finnas i B-registret
                          294. 
00208C                    295. Alarm:
00208C 39                 296. 	pshc
00208D B7 10              297. 	tfr	b,a
00208F 97                 298. 	tsta
002090 27 19              299. 	beq	AlarmReturn
002092                    300. 			
002092                    301. AlarmSend:
002092 C6 04              302. 	ldab	#4		; Bit nummer 4 ‰r larm
002094 16 20 3F           303. 	jsr	Outone		; S‰tt pÂ alarm
002097                    304. 	
002097 C6 04              305. 	ldab	#4
002099 16 20 19           306. 	jsr	DELAY_B		; 4*250 ms delay
00209C                    307. 	
00209C C6 04              308. 	ldab	#4		; St‰ng av alarm
00209E 16 20 25           309. 	jsr	Outzero
0020A1                    310. 	
0020A1 43                 311. 	deca			; A<-A-1, returnera om A ‰r 0
0020A2 27 07              312. 	beq	AlarmReturn
0020A4                    313. 	
0020A4 C6 02              314. 	ldab	#2		; A ‰r inte 0. Skicka 2*250 ms delay
0020A6 16 20 19           315. 	jsr	DELAY_B
0020A9                    316. 	
0020A9 20 E7              317. 	bra	AlarmSend	; Loopa om alarmet
0020AB                    318. AlarmReturn:
0020AB 38                 319. 	pulc
0020AC 3D                 320. 	rts
0020AD                    321. 	
                          322. ;-------------------------------
                          323. ;	STEP
                          324. ;-------------------------------
                          325. 
0020AD                    326. Step:
0020AD B6 04 01           327. 	ldaa	DrillStatus
0020B0 84 02              328. 	anda	#2	; Maska ut bit 1
0020B2 27 17              329. 	beq	StepAlarm
0020B4                    330. 			; Borren uppe
0020B4 C6 01              331. 	ldab	#1
0020B6 16 20 3F           332. 	jsr	Outone	; Ettst‰ll bit 1 (medurs riktning)
0020B9                    333. 	
0020B9 C6 00              334. 	ldab	#0
0020BB 16 20 3F           335. 	jsr	Outone	; Ettst‰ll bit 0 (stegpuls)
0020BE C6 02              336. 	ldab	#2	
0020C0 16 20 19           337. 	jsr	DELAY_B	; Skicka 2*250 ms delay
0020C3                    338. 	
0020C3 C6 00              339. 	ldab	#0
0020C5 16 20 25           340. 	jsr	Outzero	; Nollst‰ll bit 0 (stegpuls)
0020C8                    341. 	
0020C8 C6 01              342. 	ldab	#1	; Returnera 1
0020CA 3D                 343. 	rts
                          344. 
0020CB                    345. StepAlarm:		; Borren inte uppe
0020CB C6 02              346. 	ldab	#2	
0020CD 16 20 8C           347. 	jsr	Alarm	; Skicka 2*250 ms delay
0020D0 C7                 348. 	clrb		; Returnera 0
0020D1 3D                 349. 	rts
0020D2                    350. 	
                          351. ;-------------------------------
                          352. ;	DRILLDOWNTEST
                          353. ;-------------------------------
0020D2                    354. DrillDownTest:
0020D2 00                 355. retry	rmb	1
0020D3 18 0B 14 20 D2     356. 	movb	#20,retry
0020D8                    357. DrillDownTestRetry:
0020D8 F6 04 01           358. 	ldab	DrillStatus
0020DB C4 04              359. 	andb	#4	; Maska fram bit 2 (borr nere)
0020DD 26 18              360. 	bne	DrillDownTestReturn1
0020DF C6 01              361. 	ldab	#1
0020E1 16 20 19           362. 	jsr	DELAY_B	; 250 ms delay
0020E4 73 20 D2           363. 	dec	retry
0020E7 F7 20 D2           364. 	tst	retry	
0020EA 26 EC              365. 	bne	DrillDownTestRetry
0020EC C6 02              366. 	ldab	#2
0020EE 16 20 8C           367. 	jsr	Alarm	; Skicka 2 alarmsignaler
0020F1 C6 00              368. 	ldab	#0
0020F3 3D                 369. 	rts		; Returnera 0
0020F4                    370. DrillDowntTestReturn1:
0020F4 C6 01              371. 	ldab	#1
0020F6 3D                 372. 	rts		; Returnera 1
0020F7                    373. 	
0020F7                    374. DrillDownTestReturn1
0020F7 C6 01              375. 	ldab	#1
0020F9 3D                 376. 	rts
0020FA                    377. 	
                          378. ;-------------------------------
                          379. ;	DRILLHOLE
                          380. ;-------------------------------
                          381. 
0020FA                    382. DrillHole:
0020FA 16 20 78           383. 	jsr	DrillDown
0020FD 16 20 D2           384. 	jsr	DrillDownTest
002100 16 20 82           385. 	jsr	DrillUp
002103 3D                 386. 	rts		; Returnerar svaret frÂn DrillDownTest
002104                    387. 	
                          388. ;-------------------------------
                          389. ;	REFPOS
                          390. ;-------------------------------
                          391. 
002104                    392. RefPos:
002104 B6 04 01           393. 	ldaa	DrillStatus
002107 84 01              394. 	anda	#1	; Maska fram bit 0 (referensposition)
002109 26 07              395. 	bne	RefPosReturn1
00210B 16 20 AD           396. 	jsr	Step
00210E D7                 397. 	tstb		; Testa svaret frÂn step
00210F 26 F3              398. 	bne	RefPos
002111 3D                 399. 	rts		; Returnera med 0
002112                    400. RefPosReturn1:
002112 C6 01              401. 	ldab	#1
002114 3D                 402. 	rts		; Returnera med 1 (har nÂtt referensposition)
002115                    403. 	
                          404. ;-------------------------------
                          405. ;	NSTEP
                          406. ;-------------------------------
002115                    407. Nstep:
002115 B7 10              408. 	tfr	b,a	; L‰gg n i A
002117 27 08              409. 	beq	NstepReturn1
002119 43                 410. 	deca
00211A 16 20 AD           411. 	jsr	Step
00211D D7                 412. 	tstb		; Testa svaret frÂn step, kanske inte behˆvs
00211E 26 F5              413. 	bne	Nstep
002120 3D                 414. 	rts		; Returnera med 0
002121                    415. NstepReturn1:
002121 C6 02              416. 	ldab	#2
002123 3D                 417. 	rts		; Returnera med 1 (framme)
002124                    418. 	
                          419. ;-------------------------------
                          420. ;	
                          421. ;-------------------------------	
                          422. 
                          423. 
                          424. 
002124                    425. 		
                          426. 
002124                    427. 		
002124                    428. 	
002124                    429. 		
002124                    430. 		
002124                    431. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          432. ;------------------------------
                          433. ;	Global constants
                          434. ;------------------------------
002124                    435. Pattern:	
002124 00 01 01 01 01 01  436. 	fcb	0,1,1,1,1,1,1,1,2,1
       01 01 02 01      
00212E 05 02 02 02 02 04  437. 	fcb	5,2,2,2,2,4,4,3,8,2
       04 03 08 02      
002138 FF                 438. 	fcb	$FF
002139                    439. 	
002139                    440. Bitmask:	
002139 01 02 04 08 10 20  441. 	fcb	1,2,4,8,16,32,64,128
       40 80            
                          442. 
002141                    443. DCShadow:
002141 00                 444. 	rmb	1
                          445. 
002142                    446. 	