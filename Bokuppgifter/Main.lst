QA12 - MC68HC12 Absolute crossassembler, Version 1.6.3
(c) GMV 1989-2013


File: Main.lst
                            1. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                            2. ;Adresser
       0000 0600            3. DipSwitch	equ	$600
       0000 0700            4. HexDisplay	equ	$700
       0000 0400            5. DrillControl	equ	$400
       0000 0401            6. DrillStatus	equ	$401
                            7. 
000000                      8. #ifdef	SIMULATOR
                           14. #else
       0000 0004           15. DelayConst	EQU	4
                           16. #endif000000                     17. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
001000                     18. 	org	$1000
001000                     19. 	
                           20. ;----------------------------------
                           21. ;	MAIN
                           22. ;----------------------------------	
001000                     23. 	
001000                     24. main_loop:
001000 16 10 4D            25. 	jsr	GetKbdML15	; Tangent till register B
001003 16 10 08            26. 	jsr	Command
001006 20 F8               27. 	bra	main_loop
001008                     28. 	
                           29. ;----------------------------------
                           30. ;	COMMAND
                           31. ;----------------------------------	
                           32. 
001008                     33. Command:
001008 C1 07               34. 	cmpb	#7
00100A 22 08               35. 	bhi	CommandExit
00100C CE 10 15            36. 	ldx	#JUMPTAB
00100F 58                  37. 	aslb		; 2 bytes per adress
001010                     38. 	ldx	b,x	; ladda rutinen
001012 15 00               39. 	jsr	,x
001014                     40. CommandExit:
001014 3D                  41. 	rts
                           42. 
                           43. ;---------------------------------
                           44. ;	Tabell med kommandon
                           45. 
001015 20 59 20 6F 20 79   46. JUMPTAB	fdb	MotorStart,MotorStop,DrillDown,DrillUp
       20 83            
00101D 20 AE 20 FB 10 31   47. 	fdb	Step,DrillHole,SUB6,SUB7
       10 37            
001025                     48. 	
                           49. ;---------------------------------
                           50. ;	Subrutiner fˆr test
                           51. 
       0000 0400           52. OutPortM	equ	$400
                           53. 
001025 18 0B 00 04 00      54. SUB4	movb	#0,OutPortM
00102A 3D                  55. 	rts
00102B 18 0B 00 04 00      56. SUB5	movb	#0,OutPortM
001030 3D                  57. 	rts
001031 18 0B 00 04 00      58. SUB6	movb	#0,OutPortM
001036 3D                  59. 	rts
001037 18 0B 00 04 00      60. SUB7	movb	#0,OutPortM
00103C 3D                  61. 	rts
00103D                     62. 		
                           63. ;-------------------------------
                           64. ;	File uses
                           65. ;-------------------------------	
00103D                     66. 	
00103D                     67. 	;use	ML15drvr.s12
                           68. 	use	KeyboardML15.s12
---- File: "KeyboardML15.s12"
                           69. ;Testprogram
                           70. ;	org	$1000
                           71. ;start:	jsr	GetKbdML15
                           72. ;	cmpb	#$FF
                           73. ;	beq	start
                           74. ;	nop
                           75. ;	bra	start
                           76. ;	ldx	#tabell
                           77. ;start:	jsr	DisplayML15
                           78. ;	bra	start
                           79. ;
                           80. ;tabell:	fcb	1,2,3,4,5,6
                           81. 
00103D                     82. 	
00103D                     83. CheckKbdML15:
00103D F6 09 C0            84. 	ldab	$9c0
001040 2A 03               85. 	bpl	CheckKbd_VA
001042 C6 FF               86. 	ldab	#$FF	
001044 3D                  87. 	rts
001045                     88. CheckKbd_VA:
001045 37                  89. 	pshb
001046                     90. CheckKbd_VA_active:
001046 F6 09 C0            91. 	ldab	$9c0
001049 2A FB               92. 	bpl	CheckKbd_VA_active
00104B 33                  93. 	pulb
00104C 3D                  94. 	rts
00104D                     95. 	
00104D                     96. GetKbdML15:
00104D 16 10 3D            97. 	jsr	CheckKbdML15
001050 C1 FF               98. 	cmpb	#$FF
001052 27 F9               99. 	beq	GetKbdML15
001054 3D                 100. 	rts
001055                    101. 	
001055                    102. DisplayML15:
001055 86 01              103. 	ldaa	#1
001057 7A 09 C2           104. 	staa	$9c2
00105A 86 D0              105. 	ldaa	#$d0
00105C 7A 09 C3           106. 	staa	$9c3
00105F 86 00              107. 	ldaa	#0
001061 7A 09 C2           108. 	staa	$9c2
001064                    109. DisplayML15_compare_loop:
001064 81 06              110. 	cmpa	#6
001066 26 09              111. 	bne	DisplayML15_not_6
001068 86 00              112. 	ldaa	#0
00106A 7A 09 C3           113. 	staa	$9c3
00106D 7A 09 C3           114. 	staa	$9c3
001070 3D                 115. 	rts
001071                    116. DisplayML15_not_6
001071                    117. 	ldab	a,x
001073 7B 09 C3           118. 	stab	$9c3
001076 42                 119. 	inca
001077 20 EB              120. 	bra	DisplayML15_compare_loop
                          121. 
001079                    122. 	
001079                    123. 	001079                    124. 	;use	Delay.s12
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          125. 	use	Subroutines.s12
---- File: "Subroutines.s12"
                          126. #define	SIMUATOR
                          127. #define	RUNFAST
                          128. 		use	Labdefs.s12
---- File: "Labdefs.s12"
                          129. ;Adresser
       0000 0600          130. DipSwitch	equ	$600
       0000 0700          131. HexDisplay	equ	$700
       0000 0400          132. DrillControl	equ	$400
       0000 0401          133. DrillStatus	equ	$401
                          134. 
001079                    135. #ifdef	SIMULATOR
                          141. #else
       0000 0004          142. DelayConst	EQU	4
                          143. #endif                          144. 		use	Delay.s12
---- File: "Delay.s12"
                          145. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                          146. ;Adresser
       0000 0600          147. DipSwitch	equ	$600
       0000 0700          148. HexDisplay	equ	$700
       0000 0400          149. DrillControl	equ	$400
       0000 0401          150. DrillStatus	equ	$401
                          151. 
001079                    152. #ifdef	SIMULATOR
                          158. #else
       0000 0004          159. DelayConst	EQU	4
                          160. #endif002000                    161. 	org	$2000
---- File: "Delay.s12"
002000 34                 162. DELAY:	pshx		; 250 ms delay
002001 35                 163. 	pshy
002002 CE 00 04           164. 	ldx	#DelayConst
002005 1A 1F              165. NEXT:	leax	-1,x
002007 CD 00 64           166. 	ldy	#100
00200A 19 5F              167. NEXT2:	leay	-1,y
00200C 8D 00 00           168. 	cpy	#0
00200F 26 F9              169. 	bne	NEXT2
002011 8E 00 00           170. 	cpx	#0
002014 26 EF              171. 	bne	NEXT
002016 31                 172. 	puly
002017 30                 173. 	pulx
002018 3D                 174. 	rts	
002019                    175. 	
002019                    176. DELAY_B:		; Calls DELAY the number of times specified in B
002019 37                 177. 	pshb
00201A D7                 178. 	tstb
00201B                    179. DELAY_B_LOOP:
00201B 27 06              180. 	beq	DELAY_B_RETURN
00201D 16 20 00           181. 	jsr	DELAY
002020 53                 182. 	decb
002021 20 F8              183. 	bra	DELAY_B_LOOP
002023                    184. DELAY_B_RETURN:
002023 33                 185. 	pulb
002024 3D                 186. 	rts                           187. 
---- File: "Subroutines.s12"
002025 00                 188. DCShadow	rmb	1	; DrillControl shadow	
002026                    189. 		
                          190. ;---------------------------------
                          191. ;	OUTZERO
                          192. ;---------------------------------
                          193. 
                          194. ; Nollst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          195. 
002026                    196. Outzero:			
002026 39                 197. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002027 37                 198. 		pshb
002028 34                 199. 		pshx
002029 C1 07              200. 		cmpb	#7		
00202B 22 0F              201. 		bhi	Outzero_return	; Kolla om talet √§r >7
00202D CE 21 05           202. 		ldx	#Bitmask
002030                    203. 		ldab	b,x				; Uppdatera b till bitmasken f√∂r b
002032 51                 204. 		comb	
002033 F4 20 25           205. 		andb	DCShadow		; Ta DCShadow && komplementet av bitmasken
002036 7B 04 00           206. 		stab	DrillControl	; Spara till borren
002039 7B 20 25           207. 		stab	DCShadow	; Spara till skuggningen
00203C                    208. Outzero_return:	
00203C 30                 209. 		pulx
00203D 33                 210. 		pulb			; √Öterst√§ll originalv√§rden
00203E 38                 211. 		pulc
00203F 3D                 212. 		rts
002040                    213. 	
                          214. ;---------------------------------
                          215. ;	OUTONE
                          216. ;---------------------------------
                          217. 
                          218. ; Ettst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          219. 
002040                    220. Outone:			
002040 39                 221. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002041 37                 222. 		pshb
002042 34                 223. 		pshx
002043 C1 07              224. 		cmpb	#7		
002045 22 0E              225. 		bhi	Outone_return	; Kolla om talet √§r >7
002047 CE 21 05           226. 		ldx	#Bitmask
00204A                    227. 		ldab	b,x	
00204C FA 20 25           228. 		orab	DCShadow	; Ta DCShadow || Bitmasken
00204F 7B 04 00           229. 		stab	DrillControl	; Spara till borren
002052 7B 20 25           230. 		stab	DCShadow	; Spara till skuggningen
002055                    231. Outone_return:	
002055 30                 232. 		pulx
002056 33                 233. 		pulb			; √Öterst√§ll originalv√§rden
002057 38                 234. 		pulc
002058 3D                 235. 		rts
002059                    236. 		
                          237. ;-------------------------------
                          238. ;	MOTORSTART
                          239. ;-------------------------------
                          240. 
002059                    241. MotorStart:
002059 37                 242. 	pshb
00205A 39                 243. 	pshc
00205B F6 20 25           244. 	ldab	DCShadow
00205E C4 04              245. 	andb	#4
002060 26 0A              246. 	bne	MotorStartExit	; Motorn redan startad
002062 C6 02              247. 	ldab	#2
002064 16 20 40           248. 	jsr	Outone		; Ettst√§ll bit 2
002067                    249. 	
002067 C6 02              250. 	ldab	#2
002069 16 20 19           251. 	jsr	DELAY_B	; 4*250 ms delay
                          252. 
00206C                    253. MotorStartExit:
00206C 38                 254. 	pulc
00206D 33                 255. 	pulb
00206E 3D                 256. 	rts
00206F                    257. 	
                          258. ;-------------------------------
                          259. ;	MOTORSTOP
                          260. ;-------------------------------
                          261. 
00206F                    262. MotorStop:
00206F 37                 263. 	pshb
002070 39                 264. 	pshc
002071 C6 02              265. 	ldab	#2
002073 16 20 26           266. 	jsr	Outzero		; Nollst√§ll bit 2
002076 38                 267. 	pulc
002077 33                 268. 	pulb
002078 3D                 269. 	rts
002079                    270. 	
                          271. ;-------------------------------
                          272. ;	DRILLDOWN
                          273. ;-------------------------------
                          274. 
002079                    275. DrillDown:
002079 37                 276. 	pshb
00207A 39                 277. 	pshc
00207B C6 03              278. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
00207D 16 20 40           279. 	jsr	Outone		; Ettst‰ll denna
002080 38                 280. 	pulc
002081 33                 281. 	pulb
002082 3D                 282. 	rts
002083                    283. 	
                          284. ;-------------------------------
                          285. ;	DRILLUP
                          286. ;-------------------------------
                          287. 
002083                    288. DrillUp:
002083 37                 289. 	pshb
002084 39                 290. 	pshc
002085 C6 03              291. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
002087 16 20 26           292. 	jsr	Outzero		; Nollst‰ll denna
00208A 38                 293. 	pulc
00208B 33                 294. 	pulb
00208C 3D                 295. 	rts
00208D                    296. 	
                          297. ;-------------------------------
                          298. ;	ALARM
                          299. ;-------------------------------
                          300. 
                          301. ; Antalet alarm ska finnas i B-registret
                          302. 
00208D                    303. Alarm:
00208D 39                 304. 	pshc
00208E B7 10              305. 	tfr	b,a
002090 97                 306. 	tsta
002091 27 19              307. 	beq	AlarmReturn
002093                    308. 			
002093                    309. AlarmSend:
002093 C6 04              310. 	ldab	#4		; Bit nummer 4 ‰r larm
002095 16 20 40           311. 	jsr	Outone		; S‰tt pÂ alarm
002098                    312. 	
002098 C6 04              313. 	ldab	#4
00209A 16 20 19           314. 	jsr	DELAY_B		; 4*250 ms delay
00209D                    315. 	
00209D C6 04              316. 	ldab	#4		; St‰ng av alarm
00209F 16 20 26           317. 	jsr	Outzero
0020A2                    318. 	
0020A2 43                 319. 	deca			; A<-A-1, returnera om A ‰r 0
0020A3 27 07              320. 	beq	AlarmReturn
0020A5                    321. 	
0020A5 C6 02              322. 	ldab	#2		; A ‰r inte 0. Skicka 2*250 ms delay
0020A7 16 20 19           323. 	jsr	DELAY_B
0020AA                    324. 	
0020AA 20 E7              325. 	bra	AlarmSend	; Loopa om alarmet
0020AC                    326. AlarmReturn:
0020AC 38                 327. 	pulc
0020AD 3D                 328. 	rts
0020AE                    329. 	
                          330. ;-------------------------------
                          331. ;	STEP
                          332. ;-------------------------------
                          333. 
0020AE                    334. Step:
0020AE B6 04 01           335. 	ldaa	DrillStatus
0020B1 84 02              336. 	anda	#2	; Maska ut bit 1
0020B3 27 17              337. 	beq	StepAlarm
0020B5                    338. 			; Borren uppe
0020B5 C6 01              339. 	ldab	#1
0020B7 16 20 40           340. 	jsr	Outone	; Ettst‰ll bit 1 (medurs riktning)
0020BA                    341. 	
0020BA C6 00              342. 	ldab	#0
0020BC 16 20 40           343. 	jsr	Outone	; Ettst‰ll bit 0 (stegpuls)
0020BF C6 02              344. 	ldab	#2	
0020C1 16 20 19           345. 	jsr	DELAY_B	; Skicka 2*250 ms delay
0020C4                    346. 	
0020C4 C6 00              347. 	ldab	#0
0020C6 16 20 26           348. 	jsr	Outzero	; Nollst‰ll bit 0 (stegpuls)
0020C9                    349. 	
0020C9 C6 01              350. 	ldab	#1	; Returnera 1
0020CB 3D                 351. 	rts
                          352. 
0020CC                    353. StepAlarm:		; Borren inte uppe
0020CC C6 02              354. 	ldab	#2	
0020CE 16 20 8D           355. 	jsr	Alarm	; Skicka 2*250 ms delay
0020D1 C7                 356. 	clrb		; Returnera 0
0020D2 3D                 357. 	rts
0020D3                    358. 	
                          359. ;-------------------------------
                          360. ;	DRILLDOWNTEST
                          361. ;-------------------------------
0020D3                    362. DrillDownTest:
0020D3 00                 363. retry	rmb	1
0020D4 18 0B 02 20 D3     364. 	movb	#2,retry
0020D9                    365. 	;ldaa	#20	; A = retry
0020D9                    366. 	;staa	retry
0020D9                    367. DrillDownTestRetry:
0020D9 F6 04 01           368. 	ldab	DrillStatus
0020DC C4 04              369. 	andb	#4	; Maska fram bit 2 (borr nere)
0020DE 26 18              370. 	bne	DrillDownTestReturn1
0020E0 C6 01              371. 	ldab	#1
0020E2 16 20 19           372. 	jsr	DELAY_B	; 250 ms delay
0020E5 73 20 D3           373. 	dec	retry
0020E8 F7 20 D3           374. 	tst	retry	
0020EB 26 EC              375. 	bne	DrillDownTestRetry
0020ED C6 02              376. 	ldab	#2
0020EF 16 20 8D           377. 	jsr	Alarm	; Skicka 2 alarmsignaler
0020F2 C6 00              378. 	ldab	#0
0020F4 3D                 379. 	rts		; Returnera 0
0020F5                    380. DrillDowntTestReturn1:
0020F5 C6 01              381. 	ldab	#1
0020F7 3D                 382. 	rts		; Returnera 1
0020F8                    383. 	
0020F8                    384. DrillDownTestReturn1
0020F8 C6 01              385. 	ldab	#1
0020FA 3D                 386. 	rts
0020FB                    387. 	
                          388. ;-------------------------------
                          389. ;	DRILLHOLE
                          390. ;-------------------------------
                          391. 
0020FB                    392. DrillHole:
0020FB 16 20 79           393. 	jsr	DrillDown
0020FE 16 20 D3           394. 	jsr	DrillDownTest
002101 16 20 83           395. 	jsr	DrillUp
002104 3D                 396. 	rts		; Returnerar svaret frÂn DrilLDownTest
                          397. 
                          398. ;-------------------------------	
                          399. ;	Bitmasks
                          400. ;-------------------------------
                          401. 
002105 01 02 04 08 10 20  402. Bitmask:	fcb	1,2,4,8,16,32,64,128
       40 80            
00210D                    403. 		
                          404. 
00210D                    405. 		
00210D                    406. 	
00210D                    407. 		
00210D                    408. 		
00210D                    409. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          410. ;------------------------------
                          411. ;	Globala variabler
                          412. ;------------------------------
                          413. 
00210D                    414. 	