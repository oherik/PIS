QA12 - MC68HC12 Absolute crossassembler, Version 1.6.3
(c) GMV 1989-2013


File: Main.lst
                            1. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                            2. ;Adresser
       0000 0600            3. DipSwitch	equ	$600
       0000 0700            4. HexDisplay	equ	$700
       0000 0400            5. DrillControl	equ	$400
       0000 0401            6. DrillStatus	equ	$401
                            7. 
000000                      8. #ifdef	SIMULATOR
                           14. #else
       0000 0004           15. DelayConst	EQU	4
                           16. #endif000000                     17. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
001000                     18. 	org	$1000
001000                     19. 	
                           20. ;----------------------------------
                           21. ;	MAIN
                           22. ;----------------------------------	
001000                     23. 	
001000                     24. main_loop:
001000 16 10 3B            25. 	jsr	GetKbdML15	; Tangent till register B
001003 16 10 08            26. 	jsr	Command
001006 20 F8               27. 	bra	main_loop
001008                     28. 	
                           29. ;----------------------------------
                           30. ;	COMMAND
                           31. ;----------------------------------	
                           32. 
001008                     33. Command:
001008 C1 07               34. 	cmpb	#7
00100A 22 08               35. 	bhi	CommandExit
00100C CE 10 15            36. 	ldx	#JUMPTAB
00100F 58                  37. 	aslb		; 2 bytes per adress
001010                     38. 	ldx	b,x	; ladda rutinen
001012 15 00               39. 	jsr	,x
001014                     40. CommandExit:
001014 3D                  41. 	rts
                           42. 
                           43. ;---------------------------------
                           44. ;	Tabell med kommandon
                           45. 
001015 20 59 20 6F 20 79   46. JUMPTAB	fdb	MotorStart,MotorStop,DrillDown,DrillUp
       20 83            
00101D 20 AE 20 FB 21 05   47. 	fdb	Step,DrillHole,RefPos,SUB7
       10 25            
001025                     48. 	
                           49. ;---------------------------------
                           50. ;	Subrutiner fˆr test
                           51. 
       0000 0400           52. OutPortM	equ	$400
                           53. 
001025 18 0B 00 04 00      54. SUB7	movb	#0,OutPortM
00102A 3D                  55. 	rts
00102B                     56. 		
                           57. ;-------------------------------
                           58. ;	File uses
                           59. ;-------------------------------	
00102B                     60. 	
00102B                     61. 	;use	ML15drvr.s12
                           62. 	use	KeyboardML15.s12
---- File: "KeyboardML15.s12"
                           63. ;Testprogram
                           64. ;	org	$1000
                           65. ;start:	jsr	GetKbdML15
                           66. ;	cmpb	#$FF
                           67. ;	beq	start
                           68. ;	nop
                           69. ;	bra	start
                           70. ;	ldx	#tabell
                           71. ;start:	jsr	DisplayML15
                           72. ;	bra	start
                           73. ;
                           74. ;tabell:	fcb	1,2,3,4,5,6
                           75. 
00102B                     76. 	
00102B                     77. CheckKbdML15:
00102B F6 09 C0            78. 	ldab	$9c0
00102E 2A 03               79. 	bpl	CheckKbd_VA
001030 C6 FF               80. 	ldab	#$FF	
001032 3D                  81. 	rts
001033                     82. CheckKbd_VA:
001033 37                  83. 	pshb
001034                     84. CheckKbd_VA_active:
001034 F6 09 C0            85. 	ldab	$9c0
001037 2A FB               86. 	bpl	CheckKbd_VA_active
001039 33                  87. 	pulb
00103A 3D                  88. 	rts
00103B                     89. 	
00103B                     90. GetKbdML15:
00103B 16 10 2B            91. 	jsr	CheckKbdML15
00103E C1 FF               92. 	cmpb	#$FF
001040 27 F9               93. 	beq	GetKbdML15
001042 3D                  94. 	rts
001043                     95. 	
001043                     96. DisplayML15:
001043 86 01               97. 	ldaa	#1
001045 7A 09 C2            98. 	staa	$9c2
001048 86 D0               99. 	ldaa	#$d0
00104A 7A 09 C3           100. 	staa	$9c3
00104D 86 00              101. 	ldaa	#0
00104F 7A 09 C2           102. 	staa	$9c2
001052                    103. DisplayML15_compare_loop:
001052 81 06              104. 	cmpa	#6
001054 26 09              105. 	bne	DisplayML15_not_6
001056 86 00              106. 	ldaa	#0
001058 7A 09 C3           107. 	staa	$9c3
00105B 7A 09 C3           108. 	staa	$9c3
00105E 3D                 109. 	rts
00105F                    110. DisplayML15_not_6
00105F                    111. 	ldab	a,x
001061 7B 09 C3           112. 	stab	$9c3
001064 42                 113. 	inca
001065 20 EB              114. 	bra	DisplayML15_compare_loop
                          115. 
001067                    116. 	
001067                    117. 	001067                    118. 	;use	Delay.s12
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          119. 	use	Subroutines.s12
---- File: "Subroutines.s12"
                          120. #define	SIMUATOR
                          121. #define	RUNFAST
                          122. 		use	Labdefs.s12
---- File: "Labdefs.s12"
                          123. ;Adresser
       0000 0600          124. DipSwitch	equ	$600
       0000 0700          125. HexDisplay	equ	$700
       0000 0400          126. DrillControl	equ	$400
       0000 0401          127. DrillStatus	equ	$401
                          128. 
001067                    129. #ifdef	SIMULATOR
                          135. #else
       0000 0004          136. DelayConst	EQU	4
                          137. #endif                          138. 		use	Delay.s12
---- File: "Delay.s12"
                          139. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                          140. ;Adresser
       0000 0600          141. DipSwitch	equ	$600
       0000 0700          142. HexDisplay	equ	$700
       0000 0400          143. DrillControl	equ	$400
       0000 0401          144. DrillStatus	equ	$401
                          145. 
001067                    146. #ifdef	SIMULATOR
                          152. #else
       0000 0004          153. DelayConst	EQU	4
                          154. #endif002000                    155. 	org	$2000
---- File: "Delay.s12"
002000 34                 156. DELAY:	pshx		; 250 ms delay
002001 35                 157. 	pshy
002002 CE 00 04           158. 	ldx	#DelayConst
002005 1A 1F              159. NEXT:	leax	-1,x
002007 CD 00 64           160. 	ldy	#100
00200A 19 5F              161. NEXT2:	leay	-1,y
00200C 8D 00 00           162. 	cpy	#0
00200F 26 F9              163. 	bne	NEXT2
002011 8E 00 00           164. 	cpx	#0
002014 26 EF              165. 	bne	NEXT
002016 31                 166. 	puly
002017 30                 167. 	pulx
002018 3D                 168. 	rts	
002019                    169. 	
002019                    170. DELAY_B:		; Calls DELAY the number of times specified in B
002019 37                 171. 	pshb
00201A D7                 172. 	tstb
00201B                    173. DELAY_B_LOOP:
00201B 27 06              174. 	beq	DELAY_B_RETURN
00201D 16 20 00           175. 	jsr	DELAY
002020 53                 176. 	decb
002021 20 F8              177. 	bra	DELAY_B_LOOP
002023                    178. DELAY_B_RETURN:
002023 33                 179. 	pulb
002024 3D                 180. 	rts                           181. 
---- File: "Subroutines.s12"
002025 00                 182. DCShadow	rmb	1	; DrillControl shadow	
002026                    183. 		
                          184. ;---------------------------------
                          185. ;	OUTZERO
                          186. ;---------------------------------
                          187. 
                          188. ; Nollst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          189. 
002026                    190. Outzero:			
002026 39                 191. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002027 37                 192. 		pshb
002028 34                 193. 		pshx
002029 C1 07              194. 		cmpb	#7		
00202B 22 0F              195. 		bhi	Outzero_return	; Kolla om talet √§r >7
00202D CE 21 25           196. 		ldx	#Bitmask
002030                    197. 		ldab	b,x				; Uppdatera b till bitmasken f√∂r b
002032 51                 198. 		comb	
002033 F4 20 25           199. 		andb	DCShadow		; Ta DCShadow && komplementet av bitmasken
002036 7B 04 00           200. 		stab	DrillControl	; Spara till borren
002039 7B 20 25           201. 		stab	DCShadow	; Spara till skuggningen
00203C                    202. Outzero_return:	
00203C 30                 203. 		pulx
00203D 33                 204. 		pulb			; √Öterst√§ll originalv√§rden
00203E 38                 205. 		pulc
00203F 3D                 206. 		rts
002040                    207. 	
                          208. ;---------------------------------
                          209. ;	OUTONE
                          210. ;---------------------------------
                          211. 
                          212. ; Ettst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                          213. 
002040                    214. Outone:			
002040 39                 215. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002041 37                 216. 		pshb
002042 34                 217. 		pshx
002043 C1 07              218. 		cmpb	#7		
002045 22 0E              219. 		bhi	Outone_return	; Kolla om talet √§r >7
002047 CE 21 25           220. 		ldx	#Bitmask
00204A                    221. 		ldab	b,x	
00204C FA 20 25           222. 		orab	DCShadow	; Ta DCShadow || Bitmasken
00204F 7B 04 00           223. 		stab	DrillControl	; Spara till borren
002052 7B 20 25           224. 		stab	DCShadow	; Spara till skuggningen
002055                    225. Outone_return:	
002055 30                 226. 		pulx
002056 33                 227. 		pulb			; √Öterst√§ll originalv√§rden
002057 38                 228. 		pulc
002058 3D                 229. 		rts
002059                    230. 		
                          231. ;-------------------------------
                          232. ;	MOTORSTART
                          233. ;-------------------------------
                          234. 
002059                    235. MotorStart:
002059 37                 236. 	pshb
00205A 39                 237. 	pshc
00205B F6 20 25           238. 	ldab	DCShadow
00205E C4 04              239. 	andb	#4
002060 26 0A              240. 	bne	MotorStartExit	; Motorn redan startad
002062 C6 02              241. 	ldab	#2
002064 16 20 40           242. 	jsr	Outone		; Ettst√§ll bit 2
002067                    243. 	
002067 C6 02              244. 	ldab	#2
002069 16 20 19           245. 	jsr	DELAY_B	; 4*250 ms delay
                          246. 
00206C                    247. MotorStartExit:
00206C 38                 248. 	pulc
00206D 33                 249. 	pulb
00206E 3D                 250. 	rts
00206F                    251. 	
                          252. ;-------------------------------
                          253. ;	MOTORSTOP
                          254. ;-------------------------------
                          255. 
00206F                    256. MotorStop:
00206F 37                 257. 	pshb
002070 39                 258. 	pshc
002071 C6 02              259. 	ldab	#2
002073 16 20 26           260. 	jsr	Outzero		; Nollst√§ll bit 2
002076 38                 261. 	pulc
002077 33                 262. 	pulb
002078 3D                 263. 	rts
002079                    264. 	
                          265. ;-------------------------------
                          266. ;	DRILLDOWN
                          267. ;-------------------------------
                          268. 
002079                    269. DrillDown:
002079 37                 270. 	pshb
00207A 39                 271. 	pshc
00207B C6 03              272. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
00207D 16 20 40           273. 	jsr	Outone		; Ettst‰ll denna
002080 38                 274. 	pulc
002081 33                 275. 	pulb
002082 3D                 276. 	rts
002083                    277. 	
                          278. ;-------------------------------
                          279. ;	DRILLUP
                          280. ;-------------------------------
                          281. 
002083                    282. DrillUp:
002083 37                 283. 	pshb
002084 39                 284. 	pshc
002085 C6 03              285. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
002087 16 20 26           286. 	jsr	Outzero		; Nollst‰ll denna
00208A 38                 287. 	pulc
00208B 33                 288. 	pulb
00208C 3D                 289. 	rts
00208D                    290. 	
                          291. ;-------------------------------
                          292. ;	ALARM
                          293. ;-------------------------------
                          294. 
                          295. ; Antalet alarm ska finnas i B-registret
                          296. 
00208D                    297. Alarm:
00208D 39                 298. 	pshc
00208E B7 10              299. 	tfr	b,a
002090 97                 300. 	tsta
002091 27 19              301. 	beq	AlarmReturn
002093                    302. 			
002093                    303. AlarmSend:
002093 C6 04              304. 	ldab	#4		; Bit nummer 4 ‰r larm
002095 16 20 40           305. 	jsr	Outone		; S‰tt pÂ alarm
002098                    306. 	
002098 C6 04              307. 	ldab	#4
00209A 16 20 19           308. 	jsr	DELAY_B		; 4*250 ms delay
00209D                    309. 	
00209D C6 04              310. 	ldab	#4		; St‰ng av alarm
00209F 16 20 26           311. 	jsr	Outzero
0020A2                    312. 	
0020A2 43                 313. 	deca			; A<-A-1, returnera om A ‰r 0
0020A3 27 07              314. 	beq	AlarmReturn
0020A5                    315. 	
0020A5 C6 02              316. 	ldab	#2		; A ‰r inte 0. Skicka 2*250 ms delay
0020A7 16 20 19           317. 	jsr	DELAY_B
0020AA                    318. 	
0020AA 20 E7              319. 	bra	AlarmSend	; Loopa om alarmet
0020AC                    320. AlarmReturn:
0020AC 38                 321. 	pulc
0020AD 3D                 322. 	rts
0020AE                    323. 	
                          324. ;-------------------------------
                          325. ;	STEP
                          326. ;-------------------------------
                          327. 
0020AE                    328. Step:
0020AE B6 04 01           329. 	ldaa	DrillStatus
0020B1 84 02              330. 	anda	#2	; Maska ut bit 1
0020B3 27 17              331. 	beq	StepAlarm
0020B5                    332. 			; Borren uppe
0020B5 C6 01              333. 	ldab	#1
0020B7 16 20 40           334. 	jsr	Outone	; Ettst‰ll bit 1 (medurs riktning)
0020BA                    335. 	
0020BA C6 00              336. 	ldab	#0
0020BC 16 20 40           337. 	jsr	Outone	; Ettst‰ll bit 0 (stegpuls)
0020BF C6 02              338. 	ldab	#2	
0020C1 16 20 19           339. 	jsr	DELAY_B	; Skicka 2*250 ms delay
0020C4                    340. 	
0020C4 C6 00              341. 	ldab	#0
0020C6 16 20 26           342. 	jsr	Outzero	; Nollst‰ll bit 0 (stegpuls)
0020C9                    343. 	
0020C9 C6 01              344. 	ldab	#1	; Returnera 1
0020CB 3D                 345. 	rts
                          346. 
0020CC                    347. StepAlarm:		; Borren inte uppe
0020CC C6 02              348. 	ldab	#2	
0020CE 16 20 8D           349. 	jsr	Alarm	; Skicka 2*250 ms delay
0020D1 C7                 350. 	clrb		; Returnera 0
0020D2 3D                 351. 	rts
0020D3                    352. 	
                          353. ;-------------------------------
                          354. ;	DRILLDOWNTEST
                          355. ;-------------------------------
0020D3                    356. DrillDownTest:
0020D3 00                 357. retry	rmb	1
0020D4 18 0B 14 20 D3     358. 	movb	#20,retry
0020D9                    359. DrillDownTestRetry:
0020D9 F6 04 01           360. 	ldab	DrillStatus
0020DC C4 04              361. 	andb	#4	; Maska fram bit 2 (borr nere)
0020DE 26 18              362. 	bne	DrillDownTestReturn1
0020E0 C6 01              363. 	ldab	#1
0020E2 16 20 19           364. 	jsr	DELAY_B	; 250 ms delay
0020E5 73 20 D3           365. 	dec	retry
0020E8 F7 20 D3           366. 	tst	retry	
0020EB 26 EC              367. 	bne	DrillDownTestRetry
0020ED C6 02              368. 	ldab	#2
0020EF 16 20 8D           369. 	jsr	Alarm	; Skicka 2 alarmsignaler
0020F2 C6 00              370. 	ldab	#0
0020F4 3D                 371. 	rts		; Returnera 0
0020F5                    372. DrillDowntTestReturn1:
0020F5 C6 01              373. 	ldab	#1
0020F7 3D                 374. 	rts		; Returnera 1
0020F8                    375. 	
0020F8                    376. DrillDownTestReturn1
0020F8 C6 01              377. 	ldab	#1
0020FA 3D                 378. 	rts
0020FB                    379. 	
                          380. ;-------------------------------
                          381. ;	DRILLHOLE
                          382. ;-------------------------------
                          383. 
0020FB                    384. DrillHole:
0020FB 16 20 79           385. 	jsr	DrillDown
0020FE 16 20 D3           386. 	jsr	DrillDownTest
002101 16 20 83           387. 	jsr	DrillUp
002104 3D                 388. 	rts		; Returnerar svaret frÂn DrillDownTest
002105                    389. 	
                          390. ;-------------------------------
                          391. ;	REFPOS
                          392. ;-------------------------------
                          393. 
002105                    394. RefPos:
002105 B6 04 01           395. 	ldaa	DrillStatus
002108 84 01              396. 	anda	#1	; Maska fram bit 0 (referensposition)
00210A 26 07              397. 	bne	RefPosReturn1
00210C 16 20 AE           398. 	jsr	Step
00210F D7                 399. 	tstb		; Testa svaret frÂn step
002110 26 F3              400. 	bne	RefPos
002112 3D                 401. 	rts		; Returnera med 0
002113                    402. RefPosReturn1:
002113 C6 01              403. 	ldab	#1
002115 3D                 404. 	rts		; Returnera med 1 (har nÂtt referensposition)
002116                    405. 	
                          406. ;-------------------------------
                          407. ;	NSTEP
                          408. ;-------------------------------
002116                    409. Nstep:
002116 B7 10              410. 	tfr	b,a	; L‰gg n i A
002118 27 08              411. 	beq	NstepReturn1
00211A 43                 412. 	deca
00211B 16 20 AE           413. 	jsr	Step
00211E D7                 414. 	tstb		; Testa svaret frÂn step, kanske inte behˆvs
00211F 26 F5              415. 	bne	Nstep
002121 3D                 416. 	rts		; Returnera med 0
002122                    417. NstepReturn1:
002122 C6 02              418. 	ldab	#2
002124 3D                 419. 	rts		; Returnera med 1 (framme)
                          420. ;-------------------------------	
                          421. ;	Bitmasks
                          422. ;-------------------------------
                          423. 
002125 01 02 04 08 10 20  424. Bitmask:	fcb	1,2,4,8,16,32,64,128
       40 80            
00212D                    425. 		
                          426. 
00212D                    427. 		
00212D                    428. 	
00212D                    429. 		
00212D                    430. 		
00212D                    431. 	
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Main.s12"
                          432. ;------------------------------
                          433. ;	Globala variabler
                          434. ;------------------------------
                          435. 
00212D                    436. 	