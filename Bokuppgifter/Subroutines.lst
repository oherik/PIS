QA12 - MC68HC12 Absolute crossassembler, Version 1.6.3
(c) GMV 1989-2013


File: Subroutines.lst
                            1. #define	SIMUATOR
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Subroutines.s12"
                            2. #define	RUNFAST
                            3. 		use	Labdefs.s12
---- File: "Labdefs.s12"
                            4. ;Adresser
       0000 0600            5. DipSwitch	equ	$600
       0000 0700            6. HexDisplay	equ	$700
       0000 0400            7. DrillControl	equ	$400
       0000 0401            8. DrillStatus	equ	$401
                            9. 
000000                     10. #ifdef	SIMULATOR
                           16. #else
       0000 0004           17. DelayConst	EQU	4
                           18. #endif                           19. 		use	Delay.s12
---- File: "Delay.s12"
                           20. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                           21. ;Adresser
       0000 0600           22. DipSwitch	equ	$600
       0000 0700           23. HexDisplay	equ	$700
       0000 0400           24. DrillControl	equ	$400
       0000 0401           25. DrillStatus	equ	$401
                           26. 
000000                     27. #ifdef	SIMULATOR
                           33. #else
       0000 0004           34. DelayConst	EQU	4
                           35. #endif002000                     36. 	org	$2000
---- File: "Delay.s12"
002000 34                  37. DELAY:	pshx		; 250 ms delay
002001 35                  38. 	pshy
002002 CE 00 04            39. 	ldx	#DelayConst
002005 1A 1F               40. NEXT:	leax	-1,x
002007 CD 00 64            41. 	ldy	#100
00200A 19 5F               42. NEXT2:	leay	-1,y
00200C 8D 00 00            43. 	cpy	#0
00200F 26 F9               44. 	bne	NEXT2
002011 8E 00 00            45. 	cpx	#0
002014 26 EF               46. 	bne	NEXT
002016 31                  47. 	puly
002017 30                  48. 	pulx
002018 3D                  49. 	rts	
002019                     50. 	
002019                     51. DELAY_B:		; Calls DELAY the number of times specified in B
002019 37                  52. 	pshb
00201A D7                  53. 	tstb
00201B                     54. DELAY_B_LOOP:
00201B 27 06               55. 	beq	DELAY_B_RETURN
00201D 16 20 00            56. 	jsr	DELAY
002020 53                  57. 	decb
002021 20 F8               58. 	bra	DELAY_B_LOOP
002023                     59. DELAY_B_RETURN:
002023 33                  60. 	pulb
002024 3D                  61. 	rts                            62. 
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Subroutines.s12"
002025 00                  63. DCShadow	rmb	1	; DrillControl shadow	
002026                     64. 		
                           65. ;---------------------------------
                           66. ;	OUTZERO
                           67. ;---------------------------------
                           68. 
                           69. ; Nollst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                           70. 
002026                     71. Outzero:			
002026 39                  72. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002027 37                  73. 		pshb
002028 34                  74. 		pshx
002029 C1 07               75. 		cmpb	#7		
00202B 22 0F               76. 		bhi	Outzero_return	; Kolla om talet √§r >7
00202D CE 20 D3            77. 		ldx	#Bitmask
002030                     78. 		ldab	b,x				; Uppdatera b till bitmasken f√∂r b
002032 51                  79. 		comb	
002033 F4 20 25            80. 		andb	DCShadow		; Ta DCShadow && komplementet av bitmasken
002036 7B 04 00            81. 		stab	DrillControl	; Spara till borren
002039 7B 20 25            82. 		stab	DCShadow	; Spara till skuggningen
00203C                     83. Outzero_return:	
00203C 30                  84. 		pulx
00203D 33                  85. 		pulb			; √Öterst√§ll originalv√§rden
00203E 38                  86. 		pulc
00203F 3D                  87. 		rts
002040                     88. 	
                           89. ;---------------------------------
                           90. ;	OUTONE
                           91. ;---------------------------------
                           92. 
                           93. ; Ettst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                           94. 
002040                     95. Outone:			
002040 39                  96. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
002041 37                  97. 		pshb
002042 34                  98. 		pshx
002043 C1 07               99. 		cmpb	#7		
002045 22 0E              100. 		bhi	Outone_return	; Kolla om talet √§r >7
002047 CE 20 D3           101. 		ldx	#Bitmask
00204A                    102. 		ldab	b,x	
00204C FA 20 25           103. 		orab	DCShadow	; Ta DCShadow || Bitmasken
00204F 7B 04 00           104. 		stab	DrillControl	; Spara till borren
002052 7B 20 25           105. 		stab	DCShadow	; Spara till skuggningen
002055                    106. Outone_return:	
002055 30                 107. 		pulx
002056 33                 108. 		pulb			; √Öterst√§ll originalv√§rden
002057 38                 109. 		pulc
002058 3D                 110. 		rts
002059                    111. 		
                          112. ;-------------------------------
                          113. ;	MOTORSTART
                          114. ;-------------------------------
                          115. 
002059                    116. MotorStart:
002059 37                 117. 	pshb
00205A 39                 118. 	pshc
00205B F6 20 25           119. 	ldab	DCShadow
00205E C4 04              120. 	andb	#4
002060 26 0A              121. 	bne	MotorStartExit	; Motorn redan startad
002062 C6 02              122. 	ldab	#2
002064 16 20 40           123. 	jsr	Outone		; Ettst√§ll bit 2
002067                    124. 	
002067 C6 02              125. 	ldab	#2
002069 16 20 19           126. 	jsr	DELAY_B	; 4*250 ms delay
                          127. 
00206C                    128. MotorStartExit:
00206C 38                 129. 	pulc
00206D 33                 130. 	pulb
00206E 3D                 131. 	rts
00206F                    132. 	
                          133. ;-------------------------------
                          134. ;	MOTORSTOP
                          135. ;-------------------------------
                          136. 
00206F                    137. MotorStop:
00206F 37                 138. 	pshb
002070 39                 139. 	pshc
002071 C6 02              140. 	ldab	#2
002073 16 20 26           141. 	jsr	Outzero		; Nollst√§ll bit 2
002076 38                 142. 	pulc
002077 33                 143. 	pulb
002078 3D                 144. 	rts
002079                    145. 	
                          146. ;-------------------------------
                          147. ;	DRILLDOWN
                          148. ;-------------------------------
                          149. 
002079                    150. DrillDown:
002079 37                 151. 	pshb
00207A 39                 152. 	pshc
00207B C6 03              153. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
00207D 16 20 40           154. 	jsr	Outone		; Ettst‰ll denna
002080 38                 155. 	pulc
002081 33                 156. 	pulb
002082 3D                 157. 	rts
002083                    158. 	
                          159. ;-------------------------------
                          160. ;	DRILLUP
                          161. ;-------------------------------
                          162. 
002083                    163. DrillUp:
002083 37                 164. 	pshb
002084 39                 165. 	pshc
002085 C6 03              166. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
002087 16 20 26           167. 	jsr	Outzero		; Nollst‰ll denna
00208A 38                 168. 	pulc
00208B 33                 169. 	pulb
00208C 3D                 170. 	rts
00208D                    171. 	
                          172. ;-------------------------------
                          173. ;	ALARM
                          174. ;-------------------------------
                          175. 
                          176. ; Antalet alarm ska finnas i B-registret
                          177. 
00208D                    178. Alarm:
00208D 39                 179. 	pshc
00208E B7 10              180. 	tfr	b,a
002090 97                 181. 	tsta
002091 27 19              182. 	beq	AlarmReturn
002093                    183. 			
002093                    184. AlarmSend:
002093 C6 04              185. 	ldab	#4		; Bit nummer 4 ‰r larm
002095 16 20 40           186. 	jsr	Outone		; S‰tt pÂ alarm
002098                    187. 	
002098 C6 04              188. 	ldab	#4
00209A 16 20 19           189. 	jsr	DELAY_B		; 4*250 ms delay
00209D                    190. 	
00209D C6 04              191. 	ldab	#4		; St‰ng av alarm
00209F 16 20 26           192. 	jsr	Outzero
0020A2                    193. 	
0020A2 43                 194. 	deca			; A<-A-1, returnera om A ‰r 0
0020A3 27 07              195. 	beq	AlarmReturn
0020A5                    196. 	
0020A5 C6 02              197. 	ldab	#2		; A ‰r inte 0. Skicka 2*250 ms delay
0020A7 16 20 19           198. 	jsr	DELAY_B
0020AA                    199. 	
0020AA 20 E7              200. 	bra	AlarmSend	; Loopa om alarmet
0020AC                    201. AlarmReturn:
0020AC 38                 202. 	pulc
0020AD 3D                 203. 	rts
0020AE                    204. 	
                          205. ;-------------------------------
                          206. ;	STEP
                          207. ;-------------------------------
                          208. 
0020AE                    209. Step:
0020AE B6 04 01           210. 	ldaa	DrillStatus
0020B1 84 02              211. 	anda	#2	; Maska ut bit 1
0020B3 27 17              212. 	beq	StepAlarm
0020B5                    213. 			; Borren uppe
0020B5 C6 01              214. 	ldab	#1
0020B7 16 20 40           215. 	jsr	Outone	; Ettst‰ll bit 1 (medurs riktning)
0020BA                    216. 	
0020BA C6 00              217. 	ldab	#0
0020BC 16 20 40           218. 	jsr	Outone	; Ettst‰ll bit 0 (stegpuls)
0020BF C6 02              219. 	ldab	#2	
0020C1 16 20 19           220. 	jsr	DELAY_B	; Skicka 2*250 ms delay
0020C4                    221. 	
0020C4 C6 00              222. 	ldab	#0
0020C6 16 20 26           223. 	jsr	Outzero	; Nollst‰ll bit 0 (stegpuls)
0020C9                    224. 	
0020C9 C6 01              225. 	ldab	#1	; Returnera 1
0020CB 3D                 226. 	rts
                          227. 
0020CC                    228. StepAlarm:		; Borren inte uppe
0020CC C6 02              229. 	ldab	#2	
0020CE 16 20 8D           230. 	jsr	Alarm	; Skicka 2*250 ms delay
0020D1 C7                 231. 	clrb		; Returnera 0
0020D2 3D                 232. 	rts
0020D3                    233. 	
0020D3                    234. 	
                          235. 
                          236. 
                          237. ;-------------------------------	
                          238. ;	Bitmasks
                          239. ;-------------------------------
                          240. 
0020D3 01 02 04 08 10 20  241. Bitmask:	fcb	1,2,4,8,16,32,64,128
       40 80            
0020DB                    242. 		
                          243. 
0020DB                    244. 		
0020DB                    245. 	
0020DB                    246. 		
0020DB                    247. 		
