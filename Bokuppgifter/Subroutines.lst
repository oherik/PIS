QA12 - MC68HC12 Absolute crossassembler, Version 1.6.3
(c) GMV 1989-2013


File: Subroutines.lst
                            1. #define	SIMUATOR
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Subroutines.s12"
                            2. #define	RUNFAST
                            3. 		use	Labdefs.s12
---- File: "Labdefs.s12"
                            4. ;Adresser
       0000 0600            5. DipSwitch	equ	$600
       0000 0700            6. HexDisplay	equ	$700
       0000 0400            7. DrillControl	equ	$400
       0000 0401            8. DrillStatus	equ	$401
                            9. 
000000                     10. #ifdef	SIMULATOR
                           16. #else
       0000 0004           17. DelayConst	EQU	4
                           18. #endif                           19. 		use	Delay.s12
---- File: "Delay.s12"
                           20. 	use	Labdefs.s12
---- File: "Labdefs.s12"
                           21. ;Adresser
       0000 0600           22. DipSwitch	equ	$600
       0000 0700           23. HexDisplay	equ	$700
       0000 0400           24. DrillControl	equ	$400
       0000 0401           25. DrillStatus	equ	$401
                           26. 
000000                     27. #ifdef	SIMULATOR
                           33. #else
       0000 0004           34. DelayConst	EQU	4
                           35. #endif000000                     36. DELAY:			; 250 ms delay
---- File: "Delay.s12"
000000 34                  37. 	pshx		
000001 35                  38. 	pshy
000002 CE 00 04            39. 	ldx	#DelayConst
000005 1A 1F               40. NEXT:	leax	-1,x
000007 CD 00 64            41. 	ldy	#100
00000A 19 5F               42. NEXT2:	leay	-1,y
00000C 8D 00 00            43. 	cpy	#0
00000F 26 F9               44. 	bne	NEXT2
000011 8E 00 00            45. 	cpx	#0
000014 26 EF               46. 	bne	NEXT
000016 31                  47. 	puly
000017 30                  48. 	pulx
000018 3D                  49. 	rts	
000019                     50. 	
000019                     51. DELAY_B:		; Calls DELAY the number of times specified in B
000019 37                  52. 	pshb
00001A D7                  53. 	tstb
00001B                     54. DELAY_B_LOOP:
00001B 27 06               55. 	beq	DELAY_B_RETURN
00001D 16 00 00            56. 	jsr	DELAY
000020 53                  57. 	decb
000021 20 F8               58. 	bra	DELAY_B_LOOP
000023                     59. DELAY_B_RETURN:
000023 33                  60. 	pulb
000024 3D                  61. 	rts 000025                     62. 		
---- File: "C:\Users\Erik\Documents\GitHub\PIS\Bokuppgifter\Subroutines.s12"
                           63. ;---------------------------------
                           64. ;	OUTZERO
                           65. ;---------------------------------
                           66. 
                           67. ; Nollst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                           68. 
000025                     69. Outzero:			
000025 39                  70. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
000026 37                  71. 		pshb
000027 34                  72. 		pshx
000028 C1 07               73. 		cmpb	#7		
00002A 22 0F               74. 		bhi	Outzero_return	; Kolla om talet √§r >7
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 18, ERROR: Undefined symbol 'Bitmask'
00002C CE 00 00            75. 		ldx	#Bitmask
00002F                     76. 		ldab	b,x				; Uppdatera b till bitmasken f√∂r b
000031 51                  77. 		comb	
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 21, ERROR: Undefined symbol 'DCShadow'
000032 F4 00 00            78. 		andb	DCShadow		; Ta DCShadow && komplementet av bitmasken
000035 7B 04 00            79. 		stab	DrillControl	; Spara till borren
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 23, ERROR: Undefined symbol 'DCShadow'
000038 7B 00 00            80. 		stab	DCShadow	; Spara till skuggningen
00003B                     81. Outzero_return:	
00003B 30                  82. 		pulx
00003C 33                  83. 		pulb			; √Öterst√§ll originalv√§rden
00003D 38                  84. 		pulc
00003E 3D                  85. 		rts
00003F                     86. 	
                           87. ;---------------------------------
                           88. ;	OUTONE
                           89. ;---------------------------------
                           90. 
                           91. ; Ettst√§ll biten i B-registret, med f√∂rprogrammerade bitm√∂nster
                           92. 
00003F                     93. Outone:			
00003F 39                  94. 		pshc	; L√§gg register p√• stacken f√∂r senare √•terst√§llning
000040 37                  95. 		pshb
000041 34                  96. 		pshx
000042 C1 07               97. 		cmpb	#7		
000044 22 0E               98. 		bhi	Outone_return	; Kolla om talet √§r >7
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 42, ERROR: Undefined symbol 'Bitmask'
000046 CE 00 00            99. 		ldx	#Bitmask
000049                    100. 		ldab	b,x	
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 44, ERROR: Undefined symbol 'DCShadow'
00004B FA 00 00           101. 		orab	DCShadow	; Ta DCShadow || Bitmasken
00004E 7B 04 00           102. 		stab	DrillControl	; Spara till borren
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 46, ERROR: Undefined symbol 'DCShadow'
000051 7B 00 00           103. 		stab	DCShadow	; Spara till skuggningen
000054                    104. Outone_return:	
000054 30                 105. 		pulx
000055 33                 106. 		pulb			; √Öterst√§ll originalv√§rden
000056 38                 107. 		pulc
000057 3D                 108. 		rts
000058                    109. 		
                          110. ;-------------------------------
                          111. ;	MOTORSTART
                          112. ;-------------------------------
                          113. 
000058                    114. MotorStart:
000058 37                 115. 	pshb
000059 39                 116. 	pshc
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 60, ERROR: Undefined symbol 'DCShadow'
00005A F6 00 00           117. 	ldab	DCShadow
00005D C4 04              118. 	andb	#4
00005F 26 05              119. 	bne	MotorStartExit	; Motorn redan startad
000061 C6 02              120. 	ldab	#2
000063 16 00 3F           121. 	jsr	Outone		; Ettst√§ll bit 2
000066                    122. 	
000066                    123. 	;ldab	#4
000066                    124. 	;jsr	DELAY_B	; 4*250 ms delay
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 68, ERROR: Illegal mnemonic
000066                    125. jsr 	DELAY
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 69, ERROR: Illegal mnemonic
000066                    126. jsr 	DELAY
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 70, ERROR: Illegal mnemonic
000066                    127. jsr 	DELAY
"C:/Users/Erik/Documents/GitHub/PIS/Bokuppgifter/Subroutines.s12" line 71, ERROR: Illegal mnemonic
000066                    128. jsr 	DELAY
000066                    129. MotorStartExit:
000066 38                 130. 	pulc
000067 33                 131. 	pulb
000068 3D                 132. 	rts
000069                    133. 	
                          134. ;-------------------------------
                          135. ;	MOTORSTOP
                          136. ;-------------------------------
                          137. 
000069                    138. MotorStop:
000069 37                 139. 	pshb
00006A 39                 140. 	pshc
00006B C6 02              141. 	ldab	#2
00006D 16 00 25           142. 	jsr	Outzero		; Nollst√§ll bit 2
000070 38                 143. 	pulc
000071 33                 144. 	pulb
000072 3D                 145. 	rts
000073                    146. 	
                          147. ;-------------------------------
                          148. ;	DRILLDOWN
                          149. ;-------------------------------
                          150. 
000073                    151. DrillDown:
000073 37                 152. 	pshb
000074 39                 153. 	pshc
000075 C6 03              154. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
000077 16 00 3F           155. 	jsr	Outone		; Ettst‰ll denna
00007A 38                 156. 	pulc
00007B 33                 157. 	pulb
00007C 3D                 158. 	rts
00007D                    159. 	
                          160. ;-------------------------------
                          161. ;	DRILLUP
                          162. ;-------------------------------
                          163. 
00007D                    164. DrillUp:
00007D 37                 165. 	pshb
00007E 39                 166. 	pshc
00007F C6 03              167. 	ldab	#3		; Bit nummer 3 ‰r vridmagneten
000081 16 00 25           168. 	jsr	Outzero		; Nollst‰ll denna
000084 38                 169. 	pulc
000085 33                 170. 	pulb
000086 3D                 171. 	rts
000087                    172. 	
                          173. ;-------------------------------
                          174. ;	ALARM
                          175. ;-------------------------------
                          176. 
                          177. ; Antalet alarm ska finnas i B-registret
                          178. 
000087                    179. Alarm:
000087 39                 180. 	pshc
000088 B7 10              181. 	tfr	b,a
00008A 97                 182. 	tsta
00008B 27 1A              183. 	beq	AlarmReturn
00008D                    184. 			
00008D                    185. AlarmSend:
00008D C6 04              186. 	ldab	#4		; Bit nummer 4 ‰r larm
00008F 16 00 3F           187. 	jsr	Outone		; S‰tt pÂ alarm
000092                    188. 	
000092 C6 04              189. 	ldab	#4
000094 16 00 19           190. 	jsr	DELAY_B		; 4*250 ms delay
000097                    191. 	
000097 C6 04              192. 	ldab	#4		; St‰ng av alarm
000099 16 00 25           193. 	jsr	Outzero
00009C                    194. 	
00009C 43                 195. 	deca			; A<-A-1, returnera om A ‰r 0
00009D 27 08              196. 	beq	AlarmReturn
00009F                    197. 	
00009F                    198. 	;ldab	#2		; A ‰r inte 0. Skicka 2*250 ms delay
00009F                    199. 	;jsr	DELAY_B
00009F 16 00 00           200. 	jsr 	DELAY
0000A2 16 00 00           201. 	jsr 	DELAY
0000A5 20 E6              202. 	bra	AlarmSend	; Loopa om alarmet
0000A7                    203. AlarmReturn:
0000A7 38                 204. 	pulc
0000A8 3D                 205. 	rts
0000A9                    206. 	
                          207. ;-------------------------------
                          208. ;	STEP
                          209. ;-------------------------------
                          210. 
0000A9                    211. Step:
0000A9 B6 04 01           212. 	ldaa	DrillStatus
0000AC 84 02              213. 	anda	#2	; Maska ut bit 1
0000AE 27 18              214. 	beq	StepAlarm
0000B0                    215. 			; Borren uppe
0000B0 C6 01              216. 	ldab	#1
0000B2 16 00 3F           217. 	jsr	Outone	; Ettst‰ll bit 1 (medurs riktning)
0000B5                    218. 	
0000B5 C6 00              219. 	ldab	#0
0000B7 16 00 3F           220. 	jsr	Outone	; Ettst‰ll bit 0 (stegpuls)
0000BA                    221. 	;ldab	#2	
0000BA                    222. 	;jsr	DELAY_B	; Skicka 2*250 ms delay
0000BA 16 00 00           223. 	jsr 	DELAY
0000BD 16 00 00           224. 	jsr 	DELAY
0000C0 C6 00              225. 	ldab	#0
0000C2 16 00 25           226. 	jsr	Outzero	; Nollst‰ll bit 0 (stegpuls)
0000C5                    227. 	
0000C5 C6 01              228. 	ldab	#1	; Returnera 1
0000C7 3D                 229. 	rts
                          230. 
0000C8                    231. StepAlarm:		; Borren inte uppe
0000C8 C6 02              232. 	ldab	#2	
0000CA 16 00 87           233. 	jsr	Alarm	; Skicka 2*250 ms delay
0000CD C6 00              234. 	ldab	#0	; Returnera 0
0000CF 3D                 235. 	rts
0000D0                    236. 	
                          237. ;-------------------------------
                          238. ;	DRILLDOWNTEST
                          239. ;-------------------------------
                          240. 
0000D0                    241. DrillDownTest:
0000D0 00                 242. retry	rmb	1
0000D1 18 0B 14 00 D0     243. 	movb	#20,retry
0000D6                    244. DrillDownTestRetry:
0000D6 F6 04 01           245. 	ldab	DrillStatus
0000D9 C4 04              246. 	andb	#4	; Maska fram bit 2 (borr nere)
0000DB 26 16              247. 	bne	DrillDownTestReturn1
0000DD                    248. 	;ldab	#1
0000DD                    249. 	;jsr	DELAY_B	; 250 ms delay
0000DD 16 00 00           250. 	jsr 	DELAY
0000E0 73 00 D0           251. 	dec	retry
0000E3 F7 00 D0           252. 	tst	retry	
0000E6 26 EE              253. 	bne	DrillDownTestRetry
0000E8 C6 02              254. 	ldab	#2
0000EA 16 00 87           255. 	jsr	Alarm	; Skicka 2 alarmsignaler
0000ED C6 00              256. 	ldab	#0
0000EF 3D                 257. 	rts		; Returnera 0
0000F0                    258. DrillDowntTestReturn1:
0000F0 C6 01              259. 	ldab	#1
0000F2 3D                 260. 	rts		; Returnera 1
0000F3                    261. 	
0000F3                    262. DrillDownTestReturn1
0000F3 C6 01              263. 	ldab	#1
0000F5 3D                 264. 	rts
0000F6                    265. 	
                          266. ;-------------------------------
                          267. ;	DRILLHOLE
                          268. ;-------------------------------
                          269. 
0000F6                    270. DrillHole:
0000F6 16 00 73           271. 	jsr	DrillDown
0000F9 16 00 D0           272. 	jsr	DrillDownTest
0000FC 16 00 7D           273. 	jsr	DrillUp
0000FF 3D                 274. 	rts		; Returnerar svaret frÂn DrillDownTest
000100                    275. 	
                          276. ;-------------------------------
                          277. ;	REFPOS
                          278. ;-------------------------------
                          279. 
000100                    280. RefPos:
000100 B6 04 01           281. 	ldaa	DrillStatus
000103 84 01              282. 	anda	#1	; Maska fram bit 0 (referensposition)
000105 26 07              283. 	bne	RefPosReturn1
000107 16 00 A9           284. 	jsr	Step
00010A D7                 285. 	tstb		; Testa svaret frÂn step
00010B 26 F3              286. 	bne	RefPos
00010D 3D                 287. 	rts		; Returnera med 0
00010E                    288. RefPosReturn1:
00010E C6 01              289. 	ldab	#1
000110 3D                 290. 	rts		; Returnera med 1 (har nÂtt referensposition)
000111                    291. 	
                          292. ;-------------------------------
                          293. ;	NSTEP
                          294. ;-------------------------------
000111                    295. Nstep:
000111 B7 10              296. 	tfr	b,a	; L‰gg n i A
000113                    297. Nstep_loop:
000113 97                 298. 	tsta
000114 27 0A              299. 	beq	NstepReturn1	; A=0?
000116 43                 300. 	deca
000117 36                 301. 	psha
000118 16 00 A9           302. 	jsr	Step
00011B 32                 303. 	pula
00011C D7                 304. 	tstb		; Testa svaret frÂn step, kanske inte behˆvs (ldab ska ‰ndra)
00011D 26 F4              305. 	bne	Nstep_loop
00011F 3D                 306. 	rts		; Returnera med 0
000120                    307. NstepReturn1:
000120 C6 01              308. 	ldab	#1
000122 3D                 309. 	rts		; Returnera med 1 (framme)
000123                    310. 	
                          311. ;-------------------------------
                          312. ;	DOAUTO
                          313. ;-------------------------------	
                          314. 
000123                    315. DoAuto:	
000123 16 01 00           316. 	jsr	RefPos
000126 D7                 317. 	tstb		; Testa svaret frÂn RefPos, kanske inte behˆvs (ldab ska ‰ndra)
000127 27 19              318. 	beq	DoAutoReturn
000129 16 00 58           319. 	jsr	MotorStart
00012C                    320. DoAutoDrill:
00012C                    321. 	ldab	,x
00012E 1A 01              322. 	leax	1,x	; ÷ka X med 1
000130 C1 FF              323. 	cmpb	#$FF	; Testa med slutmarkering
000132 27 0E              324. 	beq	DoAutoReturn
000134 16 01 11           325. 	jsr	Nstep
000137 D7                 326. 	tstb
000138 27 08              327. 	beq	DoAutoReturn
00013A 16 00 F6           328. 	jsr	DrillHole
00013D D7                 329. 	tstb
00013E 27 02              330. 	beq	DoAutoReturn
000140 20 EA              331. 	bra	DoAutoDrill
000142                    332. DoAutoReturn:
000142 16 00 69           333. 	jsr	MotorStop
000145 3D                 334. 	rts
                          335. 
000146                    336. 		
000146                    337. 		


****** Total Errors: 11
